name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m pytest test_app.py -v --cov=app --cov-report=term-missing

  deploy:
    runs-on: ubuntu-latest
    needs: test  # Only deploy if tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy with automated SSL setup
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # Set environment variables for the deployment script
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export DOMAIN="${{ secrets.DOMAIN }}"
            export EMAIL="${{ secrets.EMAIL }}"
            export EC2_HOST="${{ secrets.EC2_HOST }}"
            
            # Make deployment script executable and run it
            chmod +x ~/app/scripts/deploy.sh
            ~/app/scripts/deploy.sh
          EOF

