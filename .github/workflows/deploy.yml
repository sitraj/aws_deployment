name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.5.4
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Deploy app to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          # Ensure app directory exists and pull the latest code
          if [ ! -d ~/app ]; then
            git clone https://github.com/${{ github.repository }}.git ~/app
          fi
          cd ~/app
          git pull origin main

          # Ensure Python is available
          command -v python3 || sudo apt update && sudo apt install -y python3 python3-venv python3-pip

          # Set up virtual environment if not present
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          # Activate virtual environment and install dependencies
          source venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

          # Restart your Python app — replace this with your actual start/restart command
          # Example for systemd:
          # sudo systemctl restart myapp
          
          echo "✅ Deployment complete"
        EOF

